/*
 * A javascript-based implementation of Spatial Navigation.
 *
 * Copyright (c) 2017 Luke Chang.
 * https://github.com/luke-chang/js-spatial-navigation
 *
 * Licensed under the MPL 2.0.
 */
!function(e){"use strict";var t={selector:"",straightOnly:!1,straightOverlapThreshold:.5,rememberSource:!1,disabled:!1,defaultElement:"",enterTo:"",leaveFor:null,restrict:"self-first",tabIndexIgnoreList:"a, input, select, textarea, button, iframe, [contentEditable=true]",navigableFilter:null},r={37:"left",38:"up",39:"right",40:"down"},n={left:"right",up:"down",right:"left",down:"up"},i="sn:",o="section-",a=0,u=!1,c=!1,s={},f=0,l="",d="",v=!1,p=Element.prototype.matches||Element.prototype.matchesSelector||Element.prototype.mozMatchesSelector||Element.prototype.webkitMatchesSelector||Element.prototype.msMatchesSelector||Element.prototype.oMatchesSelector||function(e){var t=(this.parentNode||this.document).querySelectorAll(e);return[].slice.call(t).indexOf(this)>=0};function g(e){var t=e.getBoundingClientRect(),r={left:t.left,top:t.top,right:t.right,bottom:t.bottom,width:t.width,height:t.height};return r.element=e,r.center={x:r.left+Math.floor(r.width/2),y:r.top+Math.floor(r.height/2)},r.center.left=r.center.right=r.center.x,r.center.top=r.center.bottom=r.center.y,r}function h(e,t,r){for(var n=[[],[],[],[],[],[],[],[],[]],i=0;i<e.length;i++){var o,a,u=e[i],c=u.center;if(o=c.x<t.left?0:c.x<=t.right?1:2,n[a=3*(c.y<t.top?0:c.y<=t.bottom?1:2)+o].push(u),-1!==[0,2,6,8].indexOf(a)){var s=r;u.left<=t.right-t.width*s&&(2===a?n[1].push(u):8===a&&n[7].push(u)),u.right>=t.left+t.width*s&&(0===a?n[1].push(u):6===a&&n[7].push(u)),u.top<=t.bottom-t.height*s&&(6===a?n[3].push(u):8===a&&n[5].push(u)),u.bottom>=t.top+t.height*s&&(0===a?n[3].push(u):2===a&&n[5].push(u))}}return n}function b(e,t,r,n){if(!(e&&t&&r&&r.length))return null;for(var i=[],o=0;o<r.length;o++){var a=g(r[o]);a&&i.push(a)}if(!i.length)return null;var u=g(e);if(!u)return null;var c,s=function(e){return{nearPlumbLineIsBetter:function(t){var r;return(r=t.center.x<e.center.x?e.center.x-t.right:t.left-e.center.x)<0?0:r},nearHorizonIsBetter:function(t){var r;return(r=t.center.y<e.center.y?e.center.y-t.bottom:t.top-e.center.y)<0?0:r},nearTargetLeftIsBetter:function(t){var r;return(r=t.center.x<e.center.x?e.left-t.right:t.left-e.left)<0?0:r},nearTargetTopIsBetter:function(t){var r;return(r=t.center.y<e.center.y?e.top-t.bottom:t.top-e.top)<0?0:r},topIsBetter:function(e){return e.top},bottomIsBetter:function(e){return-1*e.bottom},leftIsBetter:function(e){return e.left},rightIsBetter:function(e){return-1*e.right}}}(u),f=h(i,u,n.straightOverlapThreshold),l=h(f[4],u.center,n.straightOverlapThreshold);switch(t){case"left":c=[{group:l[0].concat(l[3]).concat(l[6]),distance:[s.nearPlumbLineIsBetter,s.topIsBetter]},{group:f[3],distance:[s.nearPlumbLineIsBetter,s.topIsBetter]},{group:f[0].concat(f[6]),distance:[s.nearHorizonIsBetter,s.rightIsBetter,s.nearTargetTopIsBetter]}];break;case"right":c=[{group:l[2].concat(l[5]).concat(l[8]),distance:[s.nearPlumbLineIsBetter,s.topIsBetter]},{group:f[5],distance:[s.nearPlumbLineIsBetter,s.topIsBetter]},{group:f[2].concat(f[8]),distance:[s.nearHorizonIsBetter,s.leftIsBetter,s.nearTargetTopIsBetter]}];break;case"up":c=[{group:l[0].concat(l[1]).concat(l[2]),distance:[s.nearHorizonIsBetter,s.leftIsBetter]},{group:f[1],distance:[s.nearHorizonIsBetter,s.leftIsBetter]},{group:f[0].concat(f[2]),distance:[s.nearPlumbLineIsBetter,s.bottomIsBetter,s.nearTargetLeftIsBetter]}];break;case"down":c=[{group:l[6].concat(l[7]).concat(l[8]),distance:[s.nearHorizonIsBetter,s.leftIsBetter]},{group:f[7],distance:[s.nearHorizonIsBetter,s.leftIsBetter]},{group:f[6].concat(f[8]),distance:[s.nearPlumbLineIsBetter,s.topIsBetter,s.nearTargetLeftIsBetter]}];break;default:return null}n.straightOnly&&c.pop();var d=function(e){for(var t=null,r=0;r<e.length;r++)if(e[r].group.length){t=e[r];break}if(!t)return null;var n=t.distance;return t.group.sort(function(e,t){for(var r=0;r<n.length;r++){var i=n[r],o=i(e)-i(t);if(o)return o}return 0}),t.group}(c);if(!d)return null;var v=null;if(n.rememberSource&&n.previous&&n.previous.destination===e&&n.previous.reverse===t)for(var p=0;p<d.length;p++)if(d[p].element===n.previous.target){v=d[p].element;break}return v||(v=d[0].element),v}function m(t){return e?e(t).get():"string"==typeof t?[].slice.call(document.querySelectorAll(t)):"object"==typeof t&&t.length?[].slice.call(t):"object"==typeof t&&1===t.nodeType?[t]:[]}function y(t,r){return e?e(t).is(r):"string"==typeof r?p.call(t,r):"object"==typeof r&&r.length?r.indexOf(t)>=0:"object"==typeof r&&1===r.nodeType&&t===r}function w(){var e=document.activeElement;if(e&&e!==document.body)return e}function I(e){e=e||{};for(var t=1;t<arguments.length;t++)if(arguments[t])for(var r in arguments[t])arguments[t].hasOwnProperty(r)&&void 0!==arguments[t][r]&&(e[r]=arguments[t][r]);return e}function B(e,t){Array.isArray(t)||(t=[t]);for(var r,n=0;n<t.length;n++)(r=e.indexOf(t[n]))>=0&&e.splice(r,1);return e}function E(e,r,n){if(!e||!r||!s[r]||s[r].disabled)return!1;if(e.offsetWidth<=0&&e.offsetHeight<=0||e.hasAttribute("disabled"))return!1;if(n&&!y(e,s[r].selector))return!1;if("function"==typeof s[r].navigableFilter){if(!1===s[r].navigableFilter(e,r))return!1}else if("function"==typeof t.navigableFilter&&!1===t.navigableFilter(e,r))return!1;return!0}function x(e){for(var t in s)if(!s[t].disabled&&y(e,s[t].selector))return t}function L(e){return m(s[e].selector).filter(function(t){return E(t,e)})}function k(t){var r=s[t].defaultElement;return r?("string"==typeof r?r=m(r)[0]:e&&r instanceof e&&(r=r.get(0)),E(r,t,!0)?r:null):null}function S(e){var t=s[e].lastFocusedElement;return E(t,e,!0)?t:null}function T(e,t,r,n){arguments.length<4&&(n=!0);var o=document.createEvent("CustomEvent");return o.initCustomEvent(i+t,!0,n,r),e.dispatchEvent(o)}function F(e,t,r){if(!e)return!1;var n=w(),i=function(){n&&n.blur(),e.focus(),O(e,t)};if(v)return i(),!0;if(v=!0,c)return i(),v=!1,!0;if(n){var o={nextElement:e,nextSectionId:t,direction:r,native:!1};if(!T(n,"willunfocus",o))return v=!1,!1;n.blur(),T(n,"unfocused",o,!1)}var a={previousElement:n,sectionId:t,direction:r,native:!1};return T(e,"willfocus",a)?(e.focus(),T(e,"focused",a,!1),v=!1,O(e,t),!0):(v=!1,!1)}function O(e,t){t||(t=x(e)),t&&(s[t].lastFocusedElement=e,d=t)}function j(e,t){if("@"==e.charAt(0)){return 1==e.length?P():P(e.substr(1))}else{var r=m(e)[0];if(r){var n=x(r);if(E(r,n))return F(r,n,t)}}return!1}function P(e){var t=[],r=function(e){e&&t.indexOf(e)<0&&s[e]&&!s[e].disabled&&t.push(e)};e?r(e):(r(l),r(d),Object.keys(s).map(r));for(var n=0;n<t.length;n++){var i,o=t[n];if(i="last-focused"==s[o].enterTo?S(o)||k(o)||L(o)[0]:k(o)||S(o)||L(o)[0])return F(i,o)}return!1}function A(e,t){T(e,"navigatefailed",{direction:t},!1)}function z(t,r){if(s[t].leaveFor&&void 0!==s[t].leaveFor[r]){var n=s[t].leaveFor[r];if("string"==typeof n)return""===n?null:j(n,r);e&&n instanceof e&&(n=n.get(0));var i=x(n);if(E(n,i))return F(n,i,r)}return!1}function H(e,r,i){var o=r.getAttribute("data-sn-"+e);if("string"==typeof o)return!(""===o||!j(o,e))||(A(r,e),!1);var a={},u=[];for(var c in s)a[c]=L(c),u=u.concat(a[c]);var f,l=I({},t,s[i]);if("self-only"==l.restrict||"self-first"==l.restrict){var d=a[i];(f=b(r,e,B(d,r),l))||"self-first"!=l.restrict||(f=b(r,e,B(u,d),l))}else f=b(r,e,B(u,r),l);if(f){s[i].previous={target:r,destination:f,reverse:n[e]};var v=x(f);if(i!=v){var p,g=z(i,e);if(g)return!0;if(null===g)return A(r,e),!1;switch(s[v].enterTo){case"last-focused":p=S(v)||k(v);break;case"default-element":p=k(v)}p&&(f=p)}return F(f,v,e)}return!!z(i,e)||(A(r,e),!1)}function K(e){if(!(!f||c||e.altKey||e.ctrlKey||e.metaKey||e.shiftKey)){var t,n=function(){return e.preventDefault(),e.stopPropagation(),!1},i=r[e.keyCode];if(!i)return 13==e.keyCode&&(t=w())&&x(t)&&!T(t,"enter-down")?n():void 0;if(!(t=w())&&(d&&(t=S(d)),!t))return P(),n();var o=x(t);if(o)return T(t,"willmove",{direction:i,sectionId:o,cause:"keydown"})&&H(i,t,o),n()}}function C(e){if(!(e.altKey||e.ctrlKey||e.metaKey||e.shiftKey)&&!c&&f&&13==e.keyCode){var t=w();t&&x(t)&&(T(t,"enter-up")||(e.preventDefault(),e.stopPropagation()))}}function M(e){var t=e.target;if(t!==window&&t!==document&&f&&!v){var r=x(t);if(r){if(c)return void O(t,r);var n={sectionId:r,native:!0};T(t,"willfocus",n)?(T(t,"focused",n,!1),O(t,r)):(v=!0,t.blur(),v=!1)}}}function N(e){var t=e.target;if(t!==window&&t!==document&&!c&&f&&!v&&x(t)){var r={native:!0};T(t,"willunfocus",r)?T(t,"unfocused",r,!1):(v=!0,setTimeout(function(){t.focus(),v=!1}))}}var D={init:function(){u||(window.addEventListener("keydown",K),window.addEventListener("keyup",C),window.addEventListener("focus",M,!0),window.addEventListener("blur",N,!0),u=!0)},uninit:function(){window.removeEventListener("blur",N,!0),window.removeEventListener("focus",M,!0),window.removeEventListener("keyup",C),window.removeEventListener("keydown",K),D.clear(),a=0,u=!1},clear:function(){s={},f=0,l="",d="",v=!1},set:function(){var e,r;if("object"==typeof arguments[0])r=arguments[0];else{if("string"!=typeof arguments[0]||"object"!=typeof arguments[1])return;if(e=arguments[0],r=arguments[1],!s[e])throw new Error('Section "'+e+"\" doesn't exist!")}for(var n in r)void 0!==t[n]&&(e?s[e][n]=r[n]:void 0!==r[n]&&(t[n]=r[n]));e&&(s[e]=I({},s[e]))},add:function(){var e,t={};if("object"==typeof arguments[0]?t=arguments[0]:"string"==typeof arguments[0]&&"object"==typeof arguments[1]&&(e=arguments[0],t=arguments[1]),e||(e="string"==typeof t.id?t.id:function(){for(var e;e=o+String(++a),s[e];);return e}()),s[e])throw new Error('Section "'+e+'" has already existed!');return s[e]={},f++,D.set(e,t),e},remove:function(e){if(!e||"string"!=typeof e)throw new Error('Please assign the "sectionId"!');return!!s[e]&&(s[e]=void 0,s=I({},s),f--,d===e&&(d=""),!0)},disable:function(e){return!!s[e]&&(s[e].disabled=!0,!0)},enable:function(e){return!!s[e]&&(s[e].disabled=!1,!0)},pause:function(){c=!0},resume:function(){c=!1},focus:function(t,r){var n=!1;void 0===r&&"boolean"==typeof t&&(r=t,t=void 0);var i=!c&&r;if(i&&D.pause(),t)if("string"==typeof t)n=s[t]?P(t):j(t);else{e&&t instanceof e&&(t=t.get(0));var o=x(t);E(t,o)&&(n=F(t,o))}else n=P();return i&&D.resume(),n},move:function(e,t){if(e=e.toLowerCase(),!n[e])return!1;var r=t?m(t)[0]:w();if(!r)return!1;var i=x(r);return!!i&&(!!T(r,"willmove",{direction:e,sectionId:i,cause:"api"})&&H(e,r,i))},makeFocusable:function(e){var r=function(e){var r=void 0!==e.tabIndexIgnoreList?e.tabIndexIgnoreList:t.tabIndexIgnoreList;m(e.selector).forEach(function(e){y(e,r)||e.getAttribute("tabindex")||e.setAttribute("tabindex","-1")})};if(e){if(!s[e])throw new Error('Section "'+e+"\" doesn't exist!");r(s[e])}else for(var n in s)r(s[n])},setDefaultSection:function(e){if(e){if(!s[e])throw new Error('Section "'+e+"\" doesn't exist!");l=e}else l=""}};window.SpatialNavigation=D,"object"==typeof module&&(module.exports=D),e&&(e.SpatialNavigation=function(){if(D.init(),arguments.length>0){if(e.isPlainObject(arguments[0]))return D.add(arguments[0]);if("string"===e.type(arguments[0])&&e.isFunction(D[arguments[0]]))return D[arguments[0]].apply(D,[].slice.call(arguments,1))}return e.extend({},D)},e.fn.SpatialNavigation=function(){var t;return(t=e.isPlainObject(arguments[0])?arguments[0]:{id:arguments[0]}).selector=this,D.init(),t.id&&D.remove(t.id),D.add(t),D.makeFocusable(t.id),this})}(window.jQuery);
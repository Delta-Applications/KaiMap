HTMLCanvasElement.prototype.toBlob||Object.defineProperty(HTMLCanvasElement.prototype,"toBlob",{value:function(t,e,i){var o=this.toDataURL(e,i).split(",")[1];setTimeout((function(){for(var i=atob(o),n=i.length,s=new Uint8Array(n),a=0;a<n;a++)s[a]=i.charCodeAt(a);t(new Blob([s],{type:e||"image/png"}))}))}}),L.TileLayer.addInitHook((function(){this.options.useCache?this._db=new PouchDB("offline-tiles"):this._db=null})),L.TileLayer.prototype.options.useCache=!1,L.TileLayer.prototype.options.saveToCache=!0,L.TileLayer.prototype.options.useOnlyCache=!1,L.TileLayer.prototype.options.cacheFormat="image/png",L.TileLayer.prototype.options.cacheMaxAge=864e5,L.TileLayer.include({createTile:function(t,e){var i=document.createElement("img");i.onerror=L.bind(this._tileOnError,this,e,i),this.options.crossOrigin&&(i.crossOrigin=""),i.alt="";var o=this.getTileUrl(t);return this.options.useCache?this._db.get(o,{revs_info:!0},this._onCacheLookup(i,o,e)):(i.onload=L.bind(this._tileOnLoad,this,e,i),i.src=o),i},_onCacheLookup:function(t,e,i){return function(o,n){return n?this._onCacheHit(t,e,n,i):this._onCacheMiss(t,e,i)}.bind(this)},_onCacheHit:function(t,e,i,o){this.fire("tilecachehit",{tile:t,url:e}),this._db.getAttachment(e,"tile").then(function(n){var s=URL.createObjectURL(n);Date.now()>i.timestamp+this.options.cacheMaxAge&&!this.options.useOnlyCache?(console.log("Tile is too old: ",e),this.options.saveToCache&&(t.onload=L.bind(this._saveTile,this,t,e,i._revs_info[0].rev,o)),t.crossOrigin="Anonymous",t.src=e,t.onerror=function(t){this.src=s}):(t.onload=L.bind(this._tileOnLoad,this,o,t),t.src=s)}.bind(this))},_onCacheMiss:function(t,e,i){this.fire("tilecachemiss",{tile:t,url:e}),this.options.useOnlyCache?(t.onload=L.Util.falseFn,t.src=L.Util.emptyImageUrl):(this.options.saveToCache?t.onload=L.bind(this._saveTile,this,t,e,void 0,i):t.onload=L.bind(this._tileOnLoad,this,i,t),t.crossOrigin="Anonymous",t.src=e)},_saveTile:function(t,e,i,o){if(this.options.saveToCache){var n=document.createElement("canvas");n.width=t.naturalWidth||t.width,n.height=t.naturalHeight||t.height,n.getContext("2d").drawImage(t,0,0);var s=this.options.cacheFormat;n.toBlob(function(t){this._db.put({_id:e,_rev:i,timestamp:Date.now()}).then(function(i){return this._db.putAttachment(e,"tile",i.rev,t,s)}.bind(this)).then((function(t){o&&o()})).catch((function(){o&&o()}))}.bind(this),s)}},seed:function(t,e,i){if(this.options.useCache&&!(e>i)&&this._map){for(var o=[],n=e;n<=i;n++)for(var s=this._map.project(t.getNorthEast(),n),a=this._map.project(t.getSouthWest(),n),h=this._pxBoundsToTileRange(L.bounds([s,a])),r=h.min.y;r<=h.max.y;r++)for(var l=h.min.x;l<=h.max.x;l++){var c=new L.Point(l,r);c.z=n,o.push(this._getTileUrl(c))}var u={bbox:t,minZoom:e,maxZoom:i,queueLength:o.length};this.fire("seedstart",u);var m=this._createTile();return m._layer=this,this._seedOneTile(m,o,u),this}},_createTile:function(){return document.createElement("img")},_getTileUrl:function(t){var e=t.z;return this.options.zoomReverse&&(e=this.options.maxZoom-e),e+=this.options.zoomOffset,L.Util.template(this._url,L.extend({r:this.options.detectRetina&&L.Browser.retina&&this.options.maxZoom>0?"@2x":"",s:this._getSubdomain(t),x:t.x,y:this.options.tms?this._globalTileRange.max.y-t.y:t.y,z:this.options.maxNativeZoom?Math.min(e,this.options.maxNativeZoom):e},this.options))},_seedOneTile:function(t,e,i){if(e.length){this.fire("seedprogress",{bbox:i.bbox,minZoom:i.minZoom,maxZoom:i.maxZoom,queueLength:i.queueLength,remainingLength:e.length});var o=e.shift();this._db.get(o,function(n,s){s?this._seedOneTile(t,e,i):(t.onload=function(n){this._saveTile(t,o,null),this._seedOneTile(t,e,i)}.bind(this),t.crossOrigin="Anonymous",t.src=o)}.bind(this))}else this.fire("seedend",i)}});
